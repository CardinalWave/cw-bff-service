
<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>CardinalWave</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <title>CardinalWave</title>
    <style>
      body {
        font-family: 'Segoe UI', sans-serif;
        background-color: #110F1A;
        margin: 0;
        padding: 0;
        color: #f5f2f2;
        display: block;
        overflow-y: auto;
      }

      h3 {
        margin-bottom: 1%;
      }

      h4 {
        margin-bottom: 1%;
      }

      #app {
        max-width: 100%;
        height: 100%;
        margin: auto;
        padding: 20px;
        border-radius: 5px;
      }

      #init{
        margin:auto;
        margin-top: 10rem;
        margin-bottom: 10rem;
        width: 90%;
        padding: 10px;
        border: 1px solid #110f1a8e;
        border-radius: 20px;
        background-color: #2f2d3b;
      }

      .message-container {
	    margin-bottom: 10px;
      }

      .message-container strong {
	    color: #333;
      }

      input {
        width: 100%;
        margin-right: 10px;
        border: 1px solid #ccc;
        border-radius: 3px;
        box-sizing: border-box;
        font-size: 30px;
      }

      .btn-inputs{
        margin-top: 5%;
        display: flex;
        justify-content: space-between; /* Distribui os itens flexíveis com espaçamento entre eles */
        align-items: center; /* Alinha os itens verticalmente ao centro */
      }

      .btn-green {
        text-align: center;
        width: 35%;
        padding: 10px 0px;
        margin-top:5px;
        background-color: #00ff89;
        color: #1f1f1f;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        font-family: 'Segoe UI', sans-serif;
        font-weight: bold;
        transition: box-shadow 0.3s ease-in-out #00ff8873;
      }
      .btn-green:hover {
        box-shadow: 0 0 3px 4px #00ff8873;
      }
      
      .btn-red {
        text-align: center;
        width: 35%;
        padding: 10px 0px;
        margin-top:5px;
        background-color: #f75750;
        color: #1f1f1f;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        font-family: 'Segoe UI', sans-serif;
        font-weight: bold;
        transition: box-shadow 0.3s ease-in-out #F7614F;
      }
      .btn-red:hover {
        box-shadow: 0 0 3px 4px #F7614F;
      }
      #register {
        display: none;
      }
      #chat-list {
        display: none;
      }

      .modal{
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgb(0, 0, 0);
        background-color: rgba(0,0,0,0.4);
      }
      .modal-title {
        color: #f5f2f2;
      }
      .modal-content {
        background-color: #2f2d3b;
        margin: 15% auto; /* Espaçamento do topo e centraliza horizontalmente */
        padding: 20px;
        width: 80%; /* Largura do modal */
        max-width: 500px; /* Largura máxima do modal */
      }

      .close {
        color: #f5f2f2;
        float: right;
        font-size: 28px;
        font-weight: bold;
      }

      .close:hover,
      .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
      }

      /* Estilo do formulário dentro do modal */
      .modal-form {
        display: flex;
        flex-direction: column;
      }

      .modal-form input {
        margin-bottom: 10px;
        padding: 10px;
        font-size: 16px;
      }

      /* .modal-form button {
        padding: 10px;
        font-size: 16px;
        cursor: pointer;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 5px;
      } */

      .modal-form button:hover {
        background-color: #45a049;
      }
      .pagination {
        display: flex;
        align-items: center;
        background-color: #2f2d3b;
        height: 40px;
        border-radius: 10px;
        overflow: hidden; /* Remove a sobreposição */
      }

      .pagination button {
        flex: 1;
        display: inline-block;
        padding: 5px 10px;
        border: 1px solid #2f2d3b;
        border-radius: 5px;
        color: gainsboro;
        font-family: 'Segoe UI', sans-serif;
        font-weight: bold;
        background-color: #2f2d3b;
        transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        cursor: pointer;
        font-size: 14px;
      }

      .pagination button:hover,
      .pagination button.active {
        background-color: #3ac775;
        color: white;
        border-color: #3ac775;
      }

      .pagination button.disabled {
        color: #666;
        border-color: #2f2d3b;
        pointer-events: none;
      }

      .pagination .first,
      .pagination .last {
        padding: 5px 15px;
      }

      .pagination .first:hover,
      .pagination .last:hover {
        background-color: #3ac775;
        color: white;
      }

      .pagination button:not(:last-child) {
        border-right: 1px solid #2f2d3b; /* Adiciona borda direita entre os botões */
      }

      .pagination button:first-child {
        border-radius: 5px 0 0 5px; /* Apenas os cantos externos são arredondados */
      }

      .pagination button:last-child {
        border-radius: 0 5px 5px 0; /* Apenas os cantos externos são arredondados */
        border-right: none; /* Remove a borda direita do último botão */
      }
      .chat-header {
        width: 100%;
        background-color: #3ac775;
        font-weight: bold;
        text-align: center;
        color: #1f1f1f;
      }
      .user-list {
        padding: 0%;
        list-style-type: none;
      }
      .user-item {
        border-bottom: 1px solid #ccc;
        padding: 10px;
      }

      .user-item:last-child {
        border-bottom: none;
      }

      .user-name {
        font-weight: bold;
      }

      .user-email {
        color: #666;
      }

      #chat {
        width: 100%;
        max-width: 100%;
        background-color: #2f2d3b;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        display: none;
      }
      .chat-box {
        height: 85vh;
        overflow-y: scroll;
        overflow-x: hidden;
        padding: 10px;
        background-color: #3e3c4a;
        border-radius: 10px;
      }

      .message {
        width: 75%;
        margin-bottom: 15px;
        padding: 10px;
        background-color: #4b4860;
        border-radius: 10px;
      }
      .message_name {
        font-weight: bold;
        color: #00ff89;
      }
      .message_date {
        margin: 3%;
        color: #ccc;
      }
      .message_text {
        margin-top: 5px;
        color: #e5e5e5;
      }
      .message_user {
        width: 75%;
        margin-bottom: 15px;
        padding: 10px;
        background-color: #4b4860;
        border-radius: 10px;
        margin-left: 17vw;
      }

      .message_user .message_name {
        font-weight: bold;
        color: #a480ff;
      }

      .input-box {
        display: flex;
        justify-content: space-between;
      }
      .input-box input[type="text"] {
        width: calc(100% - 80px);
        padding: 5px;
        border: 1px solid #ccc;
        border-radius: 5px;
        margin-top: 8px;
        margin-left: 5px;
        margin-right: 10px;
        height: 40px;
      }
      .input-box button {
        padding: 10px 20px;
        background-color: #00ff89;
        color: #1f1f1f;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
      }
      /* Custom scrollbar styles */
      .chat-box::-webkit-scrollbar {
          width: 12px;
      }
      .chat-box::-webkit-scrollbar-track {
          background: #2f2d3b;
          border-radius: 10px;
      }
      .chat-box::-webkit-scrollbar-thumb {
          background-color: #00ff89;
          border-radius: 10px;
          border: 3px solid #2f2d3b;
      }
      .chat-box::-webkit-scrollbar-thumb:hover {
          background-color: #00cc70;
      }

      :root {
        --offset-size: 10rem;
        --size: -0;
        --border-color: #000000;
        --neon-color-1: #0740e8;
        --neon-color-2: #1BE9C1;
        --neon-color-3: #1BE984;
        --neon-default-color: #910900;
        --neon-secundary: #9ac8b4;
    }

    body {
        min-height: 100vh;
        min-width: 100vw;
    }

    .cardinal {
        /* transform: scale(0.9); */
        background-color: #ffdcb4;
        border: 10px solid #000;
        border-radius: 50%;
        margin-top: 20rem;
        margin-bottom: 12rem;
        margin: auto;
        width: 10em;
        height: 10em;
    }
    
    h1 {
        font-size: 30px;
        /* margin-top: 80%; */
        text-align: center;
    }

    .pixel {
        transform: scale(0.4);
        width: 1rem;
        height: 1rem;
        margin-top: 4rem;
        margin-left: 0.6rem;
        --shadow-color-2: #00ffff;
        --shadow-color-3: #ff0000;
        box-shadow: 
        
        0rem -2rem 0 var(--size) var(--border-color),
        1rem -2rem 0 var(--size) var(--border-color),
        2rem -1rem 0 var(--size) var(--border-color),
        3rem -1rem 0 var(--size) var(--border-color),
        4rem 0rem 0 var(--size) var(--border-color),
        5rem 0rem 0 var(--size) var(--border-color),
        6rem 0rem 0 var(--size) var(--border-color),
        7rem 0rem 0 var(--size) var(--border-color),
        8rem 0rem 0  var(--size) var(--border-color),
        9rem -3rem 0 var(--size) var(--border-color),
        9rem -2rem 0 var(--size) var(--border-color),
        9rem -1rem 0 var(--size) var(--border-color),
        10rem -3rem 0  var(--size) var(--border-color),
        11rem -2rem 0  var(--size) var(--border-color),
        12rem -1rem 0 var(--size) var(--border-color),
        13rem 0rem 0 var(--size) var(--border-color),
        14rem 0rem 0 var(--size) var(--border-color),
        15rem 0rem 0 var(--size) var(--border-color),
        16rem 0rem 0 var(--size) var(--border-color),
        17rem 0rem 0 var(--size) var(--border-color),
        18rem 0rem 0 var(--size) var(--border-color),
        19rem 1rem 0 var(--size) var(--border-color),
        20rem 2rem 0 var(--size) var(--border-color),
        19rem 3rem 0 var(--size) var(--border-color),


        /* Baixo */
        0rem -1rem 0 var(--size) var(--border-color),
        1rem 0rem 0 var(--size) var(--border-color),
        2rem 1rem 0 var(--size) var(--border-color),
        2rem 2rem 0 var(--size) var(--border-color),
        1rem 3rem 0 var(--size) var(--border-color),
        0rem 4rem 0 var(--size) var(--border-color),
        0rem 5rem 0 var(--size) var(--border-color),
        1rem 5rem 0 var(--size) var(--border-color),
        2rem 4rem 0 var(--size) var(--border-color),
        3rem 4rem 0 var(--size) var(--border-color),
        4rem 3rem 0 var(--size) var(--border-color),
        5rem 3rem 0 var(--size) var(--border-color),
        6rem 3rem 0 var(--size) var(--border-color),
        7rem 3rem 0 var(--size) var(--border-color),
        8rem 3rem 0  var(--size) var(--border-color),
        9rem 4rem 0 var(--size) var(--border-color),
        9rem 5rem 0 var(--size) var(--border-color),
        10rem 5rem 0  var(--size) var(--border-color),
        11rem 4rem 0  var(--size) var(--border-color),
        12rem 4rem 0 var(--size) var(--border-color),
        13rem 4rem 0 var(--size) var(--border-color),
        14rem 4rem 0 var(--size) var(--border-color),
        15rem 4rem 0 var(--size) var(--border-color),
        16rem 4rem 0 var(--size) var(--border-color),
        17rem 4rem 0 var(--size) var(--border-color),
        18rem 4rem 0 var(--size) var(--border-color),

        /* Cores */
        4rem 1rem 0 var(--size) var(--neon-color),
        5rem 1rem 0 var(--size) var(--neon-color),
        6rem 1rem 0 var(--size) var(--neon-color),
        7rem 1rem 0 var(--size) var(--neon-color),
        8rem 1rem 0 var(--size) var(--neon-color),
        9rem 1rem 0 var(--size) var(--neon-color),
        10rem 1rem 0 var(--size) var(--neon-color),
        11rem 1rem 0 var(--size) var(--neon-color),
        12rem 1rem 0 var(--size) var(--neon-color),
        13rem 1rem 0 var(--size) var(--neon-color),
        14rem 1rem 0 var(--size) var(--neon-color),
        15rem 1rem 0 var(--size) var(--neon-color),
        16rem 1rem 0 var(--size) var(--neon-color),
        17rem 1rem 0 var(--size) var(--neon-color),
        18rem 1rem 0 var(--size) var(--neon-color),
        4rem 1rem 0 var(--size) var(--neon-color),

        4rem 2rem 0 var(--size) var(--neon-default-color),
        5rem 2rem 0 var(--size) var(--neon-default-color),
        6rem 2rem 0 var(--size) var(--neon-default-color),
        7rem 2rem 0 var(--size) var(--neon-default-color),
        8rem 2rem 0 var(--size) var(--neon-default-color),
        9rem 2rem 0 var(--size) var(--neon-default-color),
        9rem 3rem 0 var(--size) var(--neon-default-color),
        10rem 2rem 0 var(--size) var(--neon-default-color),
        10rem 3rem 0 var(--size) var(--neon-default-color),
        10rem 4rem 0 var(--size) var(--neon-default-color),
        11rem 2rem 0 var(--size) var(--neon-default-color),
        11rem 3rem 0 var(--size) var(--neon-default-color),
        12rem 2rem 0 var(--size) var(--neon-default-color),
        12rem 3rem 0 var(--size) var(--neon-default-color),
        13rem 2rem 0 var(--size) var(--neon-default-color),
        13rem 3rem 0 var(--size) var(--neon-default-color),
        14rem 2rem 0 var(--size) var(--neon-default-color),
        14rem 3rem 0 var(--size) var(--neon-default-color),
        15rem 2rem 0 var(--size) var(--neon-default-color),
        15rem 3rem 0 var(--size) var(--neon-default-color),
        16rem 2rem 0 var(--size) var(--neon-default-color),
        16rem 3rem 0 var(--size) var(--neon-default-color),
        17rem 2rem 0 var(--size) var(--neon-default-color),
        17rem 3rem 0 var(--size) var(--neon-default-color),
        18rem 2rem 0 var(--size) var(--neon-default-color),
        18rem 3rem 0 var(--size) var(--neon-default-color),
        4rem 3rem 0 var(--size) var(--neon-default-color),
        19rem 2rem 0 var(--size) var(--neon-default-color),
        3rem 2rem 0 var(--size) var(--neon-secundary),
        3rem 3rem 0 var(--size) var(--neon-secundary),
        2rem 3rem 0 var(--size) var(--neon-secundary),
        1rem 4rem 0 var(--size) var(--neon-secundary),
        3rem 1rem 0 var(--size) var(--neon-secundary),
        3rem 0rem 0 var(--size) var(--neon-secundary),
        2rem 0rem 0 var(--size) var(--neon-secundary),
        1rem -1rem 0 var(--size) var(--neon-secundary),
        /* // */
        9rem 0rem 0 var(--size) var(--neon-secundary),
        10rem 0rem 0 var(--size) var(--neon-secundary),
        11rem 0rem 0 var(--size) var(--neon-secundary),
        12rem 0rem 0 var(--size) var(--neon-secundary),
        13rem 0rem 0 var(--size) var(--neon-secundary),
        14rem 0rem 0 var(--size) var(--neon-secundary),
        15rem 0rem 0 var(--size) var(--neon-secundary),
        10rem -1rem 0 var(--size) var(--neon-secundary),
        11rem -1rem 0 var(--size) var(--neon-secundary),
        10rem -2rem 0 var(--size) var(--neon-secundary);

        transition: box-shadow 0.25s ease-in-out;
        animation: mudarCores 5s linear infinite;
    }
    @keyframes mudarCores {
        0%, 100% {
          --neon-color: var(--neon-color-3);
        }
        50% {
            --neon-color: var(--neon-color-2);
        }
        60% {
            --neon-color: var(--neon-color-1)
        }
    }
    </style>
  </head>
  <body id="body">
  <div id="app">
    <div id="init">
      <div class="cardinal">
        <div class="pixel"></div>
      </div>
      <h1>CardinalWave</h1>
      <div id="login">
        <h3>Email</h3>
        <input type="text" id="ipt-user">
        <h3>Senha</h3>
        <input type="password" id="ipt-password">
        <div class="btn-inputs">
          <button id="btn-login" class="btn-green">Entrar</button>
          <button id="btn-register" class="btn-red">Criar</button>
        </div>
      </div>
      <div id="register">
        <div id="register_box">
          <h3>Email</h3>
          <input type="text" id="ipt-email">
          <h3>Nome</h3>
          <input type="text" id="ipt-username">
          <h3>Senha</h3>
          <input type="password" id="ipt-pass">
          <h3>Confirme sua senha</h3>
          <input type="password" id="ipt-pass-conf">
        </div>
        <div class="btn-inputs">
          <button id="btn-confirm" class="btn-green">Entrar</button>
          <button id="btn-clear" class="btn-red">Limpar</button>
        </div>
      </div>
    </div>
    <div id="chat-list">
      <div class="cardinal">
        <div class="pixel"></div>
      </div>
      <div class="pagination">
        <button id="group-list">Grupos</button>
        <button id="group-join">Entrar</button>
        <button id="group-create">Criar</button>
      </div>
      <div id="modal" class="modal">
        <div class="modal-content">
          <span class="close">&times;</span>
          <h2 id="modal-title" class="modal-title"></h2>
          <form class="modal-form">
              <input type="text" id="userInput" placeholder="Digite algo...">
              <button type="button" id="submitBtn" class="btn-green">Enviar</button>
          </form>
        </div>
      </div>
      <ul class="user-list">
      </ul>
      <button id="btn-logout" class="btn-red">Sair</button>
    </div>
    <div id="chat">
      <div class="chat-header"></div>
      <div class="chat-box" id="chat-box">
      </div>
      <div class="input-box">
        <input type="text" placeholder="Type your message..." id="ipt-message">
        <button id="btn-send">Send</button>
      </div>
  </div>
  <script>
  console.log(window.location.host)
  let token = "";
  // socket = new WebSocket("ws://" + window.location.hostname + ":5004");
  socket = new WebSocket("ws://" + "localhost"+ ":5004");
  socket.onopen = function(e) { console.log("[socket] socket.onopen ");};
  socket.onerror = function(e) { console.log("[socket] socket.onerror ");};
  function waitForSocketConnection() {
    return new Promise((resolve, reject) => {
        if (socket.readyState === WebSocket.OPEN) {
          resolve();
        } else {
          socket.onopen = () => resolve();
          socket.onerror = (error) => reject(error);
        }
      });
  }
  document.addEventListener('DOMContentLoaded', async function() {
    try {
      await waitForSocketConnection();  // Aguarda a conexão estar aberta
      let section = localStorage.getItem('status');
      if(section === "") {
        localStorage.setItem('status', 'login')
      }
      handleSection(section);
    } catch(error) {
      console.error('WebSocket connection error: ', error);
    }
  });
  function handleSection(section) {
    console.log(section)
    switch (section) {
      case null:
        break;
      case 'chat_list':
        document.getElementById("init").remove();
        showChatList();
        break;
      case 'chat_join':
        document.getElementById("init").remove();
        group_id = sessionStorage.getItem('group_id');
        group_title = sessionStorage.getItem('group_title');
        logoutChat();
        console.log("group_id: " + group_id);
        showChat(group_id, group_title);
      default:
        break;
    }
  }
  socket.onmessage = function(e) {
    const message = JSON.parse(e.data);
    console.log(message)
    const payload = message['payload'];
    status = localStorage.getItem('status')
    const action = message['action'];
    console.log(action)
    token = payload['token'];
    if (token !== undefined && status === "login") {
      alert(`Login realizado com sucesso!`);
      localStorage.setItem('userData', JSON.stringify(payload));
      document.getElementById("init").style.display = "none"
      localStorage.setItem('status', 'chat_list')
      showChatList();
    }
    if (status == 'chat_list' || action == 'group_list') {
      const message = JSON.parse(e.data);
      populateUserList(message.payload.groups)
    }
    if (action == 'group_create' & payload['group_id'] != undefined) {
      const parseData = JSON.parse(localStorage.getItem('userData'))
      const group_join = {
        token: parseData.token,
        group_id: payload['group_id']
      }
      session.action = "group_join";
      session.payload = group_join
      let request = JSON.stringify(session);
      socket.send(request);
    }
    if (action == 'group_join'){
      const parseData = JSON.parse(localStorage.getItem('userData'))
      const group_list= {
        token: parseData.token
      }
      session.action = "group_list";
      session.payload = group_list
      let request = JSON.stringify(session);
      socket.send(request);
    }
    if (status == 'chat_join') {
      const message = JSON.parse(e.data)
      if(message.payload.author !== undefined){
        addMessage(message.payload.author, message.payload.send_time, message.payload.payload)
      }
    }
    if (payload['error']){
      alert(payload['message'])
    }
  };
  function generateId() {
    return "sessionid_" + Math.random().toString(36).substr(2,9);
  }
  function verifySessionId() {
    let sessionId = localStorage.getItem("sessionId");
    if (!sessionId) {
      sessionId = generateId();
      localStorage.setItem("sessionId", sessionId);
    }
      return sessionId;
  }  
  let sessionId = verifySessionId();
  const session = {
    session_id: sessionId,
  };	
  function populateUserList(groups=[]) {
    const userList = document.querySelector('.user-list');
    userList.innerHTML = '';
    groups.forEach(group => {
      const li = document.createElement('li');
      li.className = 'user-item';
      li.onclick = () => handleUserClick(group.group_id, group.title);
      const nameDiv = document.createElement('div');
      nameDiv.className = 'user-name';
      nameDiv.textContent = group.title;
      li.appendChild(nameDiv);
      userList.appendChild(li);
    });
  }
  function formatTime(time) {
    if (typeof time !== 'string') {
      return 'Entrada inválida';
    }
    const timeRegex = /\d{2}:\d{2}/;
    const match = time.match(timeRegex);
    return match ? match[0] : 'Hora não encontrada';
  }
  function addMessage(name, time, text) {
    const messageContainer = document.createElement('div');
    const parseData = JSON.parse(localStorage.getItem('userData'));
    messageContainer.className = 'message';
    if(name == parseData.username){
      messageContainer.className = 'message_user';
    }
    const topDiv = document.createElement('div');
    topDiv.className = 'top';
    const nameLabel = document.createElement('label');
    nameLabel.className = 'message_name';
    nameLabel.textContent = name;
    topDiv.appendChild(nameLabel);
    const dateLabel = document.createElement('label');
    dateLabel.className = 'message_date';
    dateLabel.textContent = formatTime(time);
    topDiv.appendChild(dateLabel);
    messageContainer.appendChild(topDiv);
    const botDiv = document.createElement('div');
    botDiv.className = 'bot';
    const textLabel = document.createElement('label');
    textLabel.className = 'message_text';
    textLabel.textContent = text;
    botDiv.appendChild(textLabel);
    messageContainer.appendChild(botDiv);
    const chatBox = document.getElementById('chat-box');
    chatBox.appendChild(messageContainer);
  }
  function showChatList() {
    let chat_list = document.getElementById('chat-list');
    chat_list.style.display = 'block';
    const str_userData = localStorage.getItem('userData');
    if (str_userData) {
      const parseData = JSON.parse(str_userData)
        const chat_list = {		
        token: parseData.token,
        email: parseData.email,
        username: parseData.username
      }
      session.action = "group_list"
      session.payload = chat_list;
      let request = JSON.stringify(session);
      socket.send(request);
    }
  }
  let btn_login = document.getElementById("btn-login");  
  btn_login.addEventListener("click", function() {
    let ipt_pass = document.getElementById("ipt-password");
    let ipt_user = document.getElementById("ipt-user"); 
    const login = {		
      email:ipt_user.value,
      password:ipt_pass.value
    };
    session.action = "login";
    session.payload = login;
    let request = JSON.stringify(session);
    socket.send(request);
    ipt_user.value = '';
    ipt_pass.value = '';
    localStorage.setItem('status', "login");
  });

  function clearInputRegister(){
    document.getElementById("ipt-email").value = "";
    document.getElementById("ipt-username").value = "";
    document.getElementById("ipt-pass").value = "";
    document.getElementById("ipt-pass-conf").value = "";
  }

  let btn_confirm = document.getElementById("btn-confirm");
  btn_confirm.addEventListener("click", function() {
    let ipt_email = document.getElementById("ipt-email");
    let ipt_username = document.getElementById("ipt-username");
    let ipt_password = document.getElementById("ipt-pass");
    let ipt_password_conf = document.getElementById("ipt-pass-conf");
    if (ipt_password.value != ipt_password_conf.value) {
      alert("Senhas diferentes");
      clearInputRegister();
      return;
    }
    const register = {
      username: ipt_username.value,
      email: ipt_email.value,
      password: ipt_password.value
    }
    session.action = "register";
    session.payload = register;
    console.log(session)
    let request = JSON.stringify(session);
    socket.send(request);
  });

  let btn_clear = document.getElementById("btn-clear");
  btn_clear.addEventListener("click", function() {
    clearInputRegister();
  })
  
  let btn_logout = document.getElementById("btn-logout");
  btn_logout.addEventListener("click", function() {
    const str_userData = localStorage.getItem('userData');
    if (str_userData) {
      const parseData = JSON.parse(str_userData)
      const logout = {		
        token: parseData.token
      }
      console.log(logout)
      session.action = "logout";
      session.payload = logout
      let request = JSON.stringify(session);
      logoutChat();
      socket.send(request);
      localStorage.clear();
      sessionStorage.clear();
      location.reload();
    }
  })
  function showChat(section, title) {
    let chat_box = document.getElementById('chat');
    let chat_header = document.getElementsByClassName('chat-header');
    if (chat_header.length > 0) {
      chat_header[0].innerHTML = title + " ID:" + section;
    }
    chat_box.style.display = 'block';
    const str_userData = localStorage.getItem('userData');
    if (str_userData) {
      const parseData = JSON.parse(str_userData)
      const chat_join = {		
      token: parseData.token,
      group_id: section
    }
      session.action = "chat_join"
      session.payload = chat_join;
      let request = JSON.stringify(session);
      socket.send(request);
    }
    localStorage.setItem('status', "chat_join");
    if (window.innerWidth > 768){
      chat_box.style.marginLeft = "20%";
      chat_box.style.width = "80%";
      showChatList()
      chat_list = document.getElementById("chat-list")
      chat_list.style.display = "block";
      chat_list.style.position = "absolute";
      chat_list.style.top = 0;
      chat_list.style.left = 0;
      chat_list.style.width = "20%";
    }
  }
  let btn_send = document.getElementById("btn-send");  
  btn_send.addEventListener("click", function() {
    let ipt_message = document.getElementById("ipt-message");
    const parseData = JSON.parse(localStorage.getItem('userData'))
    const message = {
      token:parseData.token,
      message:ipt_message.value
    };
    session.action = "chat_send"
    session.payload = message;
    let request = JSON.stringify(session);	
    socket.send(request);
   });
  let btn_register = document.getElementById("btn-register");
  btn_register.addEventListener("click", function() {
    document.getElementById("login").style.display = "none";
    document.getElementById("register").style.display = "block"
  });
  function handleUserClick(section, title) {
    if (sessionStorage.getItem('group_id') || sessionStorage.getItem('group_title')){
      logoutChat();
      clearChat();
    }
    showChat(section, title);
    sessionStorage.setItem('group_id', section);
    sessionStorage.setItem('group_title', title);
    chat_list = document.getElementById("chat-list")
    if (window.innerWidth > 768) {
      chat_list.style.display = "block";
      chat_list.style.position = "absolute";
      chat_list.style.top = 0;
      chat_list.style.left = 0;
      chat_list.style.width = "20%";
    } else {
      chat_list.style.display = "none";
    }
  }
  let btn_group_create = document.getElementById("group-create");
  btn_group_create.addEventListener("click", function() {
    const message = {title: ""};
    openModal("Digite o Titulo do grupo", message, "title", "group_create");
  })
  let btn_group_join = document.getElementById("group-join");
  btn_group_join.addEventListener("click", function() {
    const parseData = JSON.parse(localStorage.getItem('userData'));
    const message = {
      token:parseData.token,
      group_id: ""
    };
    openModal("Digite o Id do grupo", message, "group_id", "group_join");
  });
  function openModal(label, message, property, action){
    let modal = document.getElementById('modal');
    let span = document.getElementsByClassName('close')[0];
    let title = document.getElementById("modal-title");
    let btn_sub = document.getElementById("submitBtn");
    let ipt_sub = document.getElementById("userInput");
    title.textContent = label
    modal.style.display = "block";
    window.onclick = function(event) {
      if (event.target == modal) {
          modal.style.display = "none";
      }
    }
    span.onclick = function() {
        modal.style.display = "none";
    }
    btn_sub.onclick = function(){
      if (ipt_sub.value !== "" ){
        message[property] = ipt_sub.value;
        session.action = action;
        session.payload = message;
        console.log(session);
        let request = JSON.stringify(session);	
        socket.send(request);
        modal.style.display = "none";
      }
      ipt_sub.value = "";
    }
  }

  function logoutChat(){
    const parseData = JSON.parse(localStorage.getItem('userData'));
    const group_id = sessionStorage.getItem('group_id')
    const logout = {
      token: parseData.token,
      group_id: group_id
    };
    session.action = "chat_leave";
    session.payload = logout;
    let request = JSON.stringify(session);
    socket.send(request);
  }

  function clearChat() {
    let chat_box = document.getElementById('chat-box')
    let chat_header = document.getElementsByClassName('chat-header')
    while (chat_box.firstChild){ 
      chat_box.removeChild(chat_box.firstChild);
    }
  }
  function handleTouchStart(event) {
    startX = event.touches[0].clientX; // Captura a posição X inicial do toque
  }
  function handleTouchMove(event) {
    if (!startX) return;
    if (status === 'chat_join') {
      const currentX = event.touches[0].clientX;
      const distance = currentX - startX;
      if (distance > 150) { 
        let chat = document.getElementById('chat');
        chat.style.display = "none";
        showChatList();
      }
    }
  }
  function windowMinimal() {
    if(window.innerWidth < 768) {
      document.addEventListener('touchstart', handleTouchStart);
      document.addEventListener('touchmove', handleTouchMove);
    }
    if(window.innerWidth > 768) {
      let init = document.getElementById("init");
      init.style.width = "30%";
      }
  }
  windowMinimal();
    
  </script>
 </body>
</html>
